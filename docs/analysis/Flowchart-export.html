<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Flowchart - Quy tr√¨nh B√°n h√†ng</title>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        h1 { color: #333; text-align: center; }
        .container { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1600px;
        }
        .instruction {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÑ FLOWCHART - Quy tr√¨nh B√°n h√†ng</h1>
        <div class="instruction">
            <strong>H∆∞·ªõng d·∫´n l∆∞u PNG:</strong> Click chu·ªôt ph·∫£i v√†o s∆° ƒë·ªì ‚Üí "Save image as..." ‚Üí L∆∞u th√†nh <code>Flowchart-Ban-Hang.png</code>
        </div>
        <div class="mermaid">
flowchart TD
    Start([B·∫Øt ƒë·∫ßu b√°n h√†ng]) --> CheckLogin{Nh√¢n vi√™n ƒë√£ ƒëƒÉng nh·∫≠p?}
    
    CheckLogin -->|Kh√¥ng| RedirectLogin[Chuy·ªÉn ƒë·∫øn trang ƒëƒÉng nh·∫≠p]
    RedirectLogin --> LoginForm[Nh·∫≠p username v√† password]
    LoginForm --> ValidateLogin{Ki·ªÉm tra th√¥ng tin}
    ValidateLogin -->|Sai| ErrorLogin[Hi·ªÉn th·ªã l·ªói ƒëƒÉng nh·∫≠p]
    ErrorLogin --> LoginForm
    ValidateLogin -->|ƒê√∫ng| SaveSession[L∆∞u session + th√¥ng tin nh√¢n vi√™n]
    SaveSession --> POSPage
    
    CheckLogin -->|C√≥| POSPage[Trang b√°n h√†ng POS]
    
    POSPage --> SearchMed[T√¨m ki·∫øm v√† ch·ªçn thu·ªëc c·∫ßn b√°n]
    
    SearchMed --> CheckInventory{Ki·ªÉm tra t·ªìn kho chi nh√°nh}
    
    CheckInventory -->|H·∫øt h√†ng| ShowAlert[Hi·ªÉn th·ªã: Thu·ªëc h·∫øt h√†ng t·∫°i chi nh√°nh]
    ShowAlert --> SuggestImport{C√≥ mu·ªën nh·∫≠p t·ª´ kho t·ªïng?}
    SuggestImport -->|C√≥| GoInventory[Chuy·ªÉn sang trang Inventory]
    GoInventory --> End1([K·∫øt th√∫c quy tr√¨nh b√°n h√†ng])
    SuggestImport -->|Kh√¥ng| SearchMed
    
    CheckInventory -->|C√≤n h√†ng| ShowStock[Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng t·ªìn kho]
    
    ShowStock --> SelectUnit[Ch·ªçn ƒë∆°n v·ªã b√°n: H·ªôp ho·∫∑c Vi√™n]
    
    SelectUnit --> InputQty[Nh·∫≠p s·ªë l∆∞·ª£ng mu·ªën b√°n]
    
    InputQty --> ValidateQty{S·ªë l∆∞·ª£ng h·ª£p l·ªá?}
    
    ValidateQty -->|V∆∞·ª£t qu√° t·ªìn kho| QtyError[Th√¥ng b√°o: Kh√¥ng ƒë·ªß h√†ng trong kho]
    QtyError --> InputQty
    
    ValidateQty -->|H·ª£p l·ªá| CalcStdQty[T√≠nh s·ªë l∆∞·ª£ng chu·∫©n theo conversion_rate]
    
    CalcStdQty --> CalcPrice[T√≠nh gi√° ti·ªÅn theo ƒë∆°n v·ªã]
    
    CalcPrice --> AddToCart[Th√™m v√†o gi·ªè h√†ng]
    
    AddToCart --> ShowCart[Hi·ªÉn th·ªã gi·ªè h√†ng v·ªõi t·ªïng ti·ªÅn]
    
    ShowCart --> MoreItems{C√≥ th√™m thu·ªëc kh√°c?}
    
    MoreItems -->|C√≥| SearchMed
    MoreItems -->|Kh√¥ng| InputCustomer[Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i kh√°ch h√†ng - t√πy ch·ªçn]
    
    InputCustomer --> CheckCustomer{Kh√°ch h√†ng ƒë√£ t·ªìn t·∫°i?}
    CheckCustomer -->|C√≥| LoadCustomer[T·∫£i th√¥ng tin + ƒëi·ªÉm t√≠ch l≈©y]
    CheckCustomer -->|Kh√¥ng| CreateCustomer[T·∫°o kh√°ch h√†ng m·ªõi]
    CreateCustomer --> LoadCustomer
    CheckCustomer -->|B·ªè qua| GuestMode[B√°n h√†ng kh√¥ng ghi nh·∫≠n kh√°ch]
    LoadCustomer --> GuestMode
    
    GuestMode --> ClickCheckout[Nh·∫•n n√∫t Thanh to√°n]
    
    ClickCheckout --> StartTransaction[B·∫Øt ƒë·∫ßu transaction database]
    
    StartTransaction --> CreateInvoice[T·∫°o h√≥a ƒë∆°n trong b·∫£ng invoices]
    
    CreateInvoice --> GetInvoiceId[L·∫•y invoice_id v·ª´a t·∫°o]
    
    GetInvoiceId --> LoopItems[Duy·ªát t·ª´ng s·∫£n ph·∫©m trong gi·ªè h√†ng]
    
    LoopItems --> InsertDetail[Th√™m v√†o b·∫£ng invoice_details]
    
    InsertDetail --> FindBatchFIFO[T√¨m batch c√≥ h·∫°n s·ª≠ d·ª•ng g·∫ßn nh·∫•t - FIFO]
    
    FindBatchFIFO --> DeductInventory[Tr·ª´ s·ªë l∆∞·ª£ng trong b·∫£ng inventory]
    
    DeductInventory --> CheckDeduct{Tr·ª´ th√†nh c√¥ng?}
    
    CheckDeduct -->|L·ªói| Rollback[Rollback transaction]
    Rollback --> ShowError[Hi·ªÉn th·ªã l·ªói giao d·ªãch]
    ShowError --> End2([K·∫øt th√∫c - Th·∫•t b·∫°i])
    
    CheckDeduct -->|Th√†nh c√¥ng| MoreItemsLoop{C√≤n s·∫£n ph·∫©m trong gi·ªè?}
    
    MoreItemsLoop -->|C√≥| LoopItems
    MoreItemsLoop -->|Kh√¥ng| UpdatePoints{Kh√°ch h√†ng c√≥ t√†i kho·∫£n?}
    
    UpdatePoints -->|C√≥| AddPoints[C·ªông ƒëi·ªÉm t√≠ch l≈©y cho kh√°ch]
    UpdatePoints -->|Kh√¥ng| CommitTransaction
    AddPoints --> CommitTransaction[Commit transaction]
    
    CommitTransaction --> ShowSuccess[Hi·ªÉn th·ªã: Thanh to√°n th√†nh c√¥ng]
    
    ShowSuccess --> PrintInvoice[In h√≥a ƒë∆°n cho kh√°ch h√†ng]
    
    PrintInvoice --> ClearCart[X√≥a gi·ªè h√†ng]
    
    ClearCart --> End3([K·∫øt th√∫c - Th√†nh c√¥ng])
    
    style Start fill:#4ade80,stroke:#22c55e,stroke-width:3px,color:#000
    style End1 fill:#4ade80,stroke:#22c55e,stroke-width:3px,color:#000
    style End2 fill:#ef4444,stroke:#dc2626,stroke-width:3px,color:#fff
    style End3 fill:#4ade80,stroke:#22c55e,stroke-width:3px,color:#000
    style ShowAlert fill:#fca5a5,stroke:#ef4444,stroke-width:2px
    style QtyError fill:#fca5a5,stroke:#ef4444,stroke-width:2px
    style ShowError fill:#fca5a5,stroke:#ef4444,stroke-width:2px
    style ShowSuccess fill:#a5f3fc,stroke:#06b6d4,stroke-width:2px
    style CommitTransaction fill:#bfdbfe,stroke:#3b82f6,stroke-width:2px
    style FindBatchFIFO fill:#fde047,stroke:#facc15,stroke-width:2px
        </div>
    </div>
</body>
</html>